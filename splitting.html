<!DOCTYPE html>
<html>
<head>
  <title>Canvas Test</title>
</head>
<body>
  <div>
    <canvas id="canvas"></canvas>
  </div>
  <div id="splited-images-container"></div>

  <script src="js/utils.js"></script>
  <script>
    window.onload = function _main() {
      var canvas = document.getElementById("canvas");
      var context = canvas.getContext("2d");

      var image = new Image();
      image.src = "img/sample.png";
      image.onload = function() {
        var width = image.width;
        var height = image.height;
        canvas.width = width;
        canvas.height = height;
        canvas.style.width = width;
        canvas.style.height = height;
        context.drawImage(image, 0, 0, width, height);

        var baseImageData = context.getImageData(0, 0, width, height);
        var group = buildGroup(baseImageData);
        colorizeBinaryImageData(baseImageData, group)
        context.putImageData(baseImageData, 0, 0)
        var splitedImages = imageDataSplitIntoGroups(baseImageData, group);

        var elSplitedImagesContainer =
          document.getElementById("splited-images-container");

        splitedImages.forEach(function _appendPartialImageCanvas(container) {
          var canvas = document.createElement("canvas");
          canvas.width = container.width;
          canvas.height = container.height;
          canvas.style.margin = "1px";
          var context = canvas.getContext("2d");
          context.putImageData(container.imageData, 0, 0)
          elSplitedImagesContainer.appendChild(canvas);
        });

      };
    };


    function colorizeBinaryImageData(imageData, group) {
      var data = imageData.data;
      var groupTable = group.groupTable;
      var numberOfGroups = group.numberOfGroups;
      var colorTable = (function _generateColorTable() {
        var colorTable = [];
        for (var groupId = 1; groupId <= numberOfGroups; groupId++) {
          colorTable[groupId] = {
            r: Math.floor(Math.random() * 256),
            g: Math.floor(Math.random() * 256),
            b: Math.floor(Math.random() * 256)
          };
        }
        return colorTable;
      })();

      var width = imageData.width;
      var height = imageData.height;
      for (var iy = 0, offsetY = 0; iy < height; iy++, offsetY += 4 * width) {
        for (var ix = 0, offsetX = 0; ix < width; ix++, offsetX += 4) {
          var headIndex = offsetY + offsetX;
          var rIndex = headIndex + 0;
          var gIndex = headIndex + 1;
          var bIndex = headIndex + 2;
          var aIndex = headIndex + 3;

          var groupId = groupTable[iy][ix];
          var colors = colorTable[groupId] || {};

          data[rIndex] = colors.r || 255;
          data[gIndex] = colors.g || 255;
          data[bIndex] = colors.b || 255;
        }
      }
    }
  </script>
</body>
</html>
